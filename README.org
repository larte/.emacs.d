* Emacs configuration
  #+Options: toc:5


** General
   #+BEGIN_SRC emacs-lisp

    (setq gc-cons-percentage 0.6)
    (setq gc-cons-threshold most-positive-fixnum)

    (setq custom-file (file-name-concat user-emacs-directory "custom.el"))
   #+END_SRC

** Basic
  #+BEGIN_SRC emacs-lisp
    (setq user-full-name "larte"
	   user-mail-address "lauri.arte@gmail.com")

    (setq warning-minimum-level :error)

    (setq initial-major-mode 'fundamental-mode)

    (setq make-backup-files nil
      create-lockfiles nil
      auto-save-default nil)
    (setq use-short-answers t)

    (setq-default indent-tabs-mode nil)
    (setq require-final-newline t)
    (add-hook 'before-save-hook 'delete-trailing-whitespace)
    (prefer-coding-system 'utf-8)
    (setq coding-system-for-read 'utf-8
	   coding-system-for-write 'utf-8)
    (setq scroll-step 1
      scroll-conservatively 10000
      auto-window-vscroll nil)
  #+END_SRC

** Appearance
 #+BEGIN_SRC emacs-lisp
   (use-package doom-modeline :ensure t)
   (use-package all-the-icons :ensure t)
   (use-package doom-themes
     :ensure t
     :config
     ;; Global settings (defaults)
     (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
           doom-themes-enable-italic t) ; if nil, italics is universally disabled
     (load-theme 'doom-dark+ t)

     ;; Enable flashing mode-line on errors
     (doom-themes-visual-bell-config)
     ;; Enable custom neotree theme (all-the-icons must be installed!)
     (setq doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
     (doom-themes-treemacs-config)
     ;; Corrects (and improves) org-mode's native fontification.
     (doom-themes-org-config))

   (if (daemonp)
       (add-hook 'after-make-frame-functions
                 (lambda (frame)
                   (with-selected-frame frame (load-theme 'doom-dark+ t))))
     (load-theme 'doom-dark+ t))
   ;; Set default font
   (set-face-attribute 'default nil
                       :family "Source Code Pro"
                       :height 110
                       :weight 'normal
                       :width 'normal)
 #+END_SRC

** Behaviour
 #+BEGIN_SRC emacs-lisp
   (use-package ibuffer :ensure t)
   (autoload 'ibuffer "ibuffer" "List buffers." t)
   (define-key global-map [(control b)] 'ibuffer)
   (global-set-key (kbd "C-c C-c") 'comment-or-uncomment-region)

   (use-package centaur-tabs
     :ensure t
     :config
     (centaur-tabs-mode t)
     (setq centaur-tabs-style "alternate")
     (setq centaur-tabs-set-icons t)
     (setq centaur-tabs-set-bar 'under)
     (setq centaur-tabs-enable-key-bindings t)
     )

   (use-package multiple-cursors :ensure t)

   ;; Global keybindings for multiple cursors
   ;;(global-set-key (kbd "C-S-c C-S-c") 'mc/edit-lines)
   (global-set-key (kbd "C-c <down>") 'mc/mark-next-like-this)
   (global-set-key (kbd "C-c <up>") 'mc/mark-previous-like-this)
   (global-set-key (kbd "C-c C-a") 'mc/mark-all-like-this)
 #+END_SRC

** Magit
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :ensure t
    :config
    (add-to-list 'magit-no-confirm 'stage-all-changes)
    (setq magit-push-always-verify nil)
   )
#+END_SRC

** Treesitter
  #+BEGIN_SRC emacs-lisp
    (use-package tree-sitter
      :ensure t
      :config
      (global-tree-sitter-mode)
      (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode))

    (use-package tree-sitter-langs
      :ensure t
      :after tree-sitter)

    (use-package apheleia
      :ensure t
      :config
      (apheleia-global-mode +1))
  #+END_SRC

** Erlang
#+BEGIN_SRC emacs-lisp
  (use-package erlang
    :ensure t
    :after tree-sitter)
  (use-package elixir-mode
    :ensure t
    :after tree-sitter)


#+END_SRC

** Typescript
  #+BEGIN_SRC emacs-lisp
    (use-package graphql-mode
      :ensure t
      :after tree-sitter)

    (use-package apheleia
      :ensure t
     )
    (use-package company :ensure t)
    (use-package flycheck :ensure t)
    (use-package typescript-mode
          :ensure t
          :after tree-sitter
          :config
          ;; we choose this instead of tsx-mode so that eglot can automatically figure out language for server
          ;; see https://github.com/joaotavora/eglot/issues/624 and https://github.com/joaotavora/eglot#handling-quirky-servers
          (define-derived-mode typescriptreact-mode typescript-mode
            "TypeScript TSX")

          ;; use our derived mode for tsx files
          (add-to-list 'auto-mode-alist '("\\.tsx?\\'" . typescriptreact-mode))
          ;; by default, typescript-mode is mapped to the treesitter typescript parser
          ;; use our derived mode to map both .tsx AND .ts -> typescriptreact-mode -> treesitter tsx
          (add-to-list 'tree-sitter-major-mode-language-alist '(typescriptreact-mode . tsx)))
  #+END_SRC

copilot:
#+BEGIN_SRC emacs-lisp
    (use-package copilot
      :ensure t
      :quelpa (copilot :fetcher github
                       :repo "zerolfx/copilot.el"
                       :branch "main"
                       :files ("dist" "*.el"))
      :hook prog-mode
      :config
      (define-key copilot-completion-map (kbd "<tab>") 'copilot-accept-completion)
      (define-key copilot-completion-map (kbd "TAB") 'copilot-accept-completion)
      )
#+END_SRC

** LSP
  #+BEGIN_SRC emacs-lisp

    (use-package lsp-ui :ensure t)
    (use-package js2-mode :ensure t)

    (use-package lsp-mode
      :ensure t
      :config
      (add-hook 'typescript-mode-hook 'lsp)
      (add-hook 'js2-mode-hook 'lsp)
      (add-hook 'erlang-mode-hook 'lsp)
      (add-hook 'elixir-mode-hook 'lsp)
      )

    (use-package yasnippet :ensure t)
    (use-package lsp-treemacs :ensure t :commands lsp-treemacs-errors-list)
    (setq lsp-language-id-configuration '((java-mode . "java")
                                          (python-mode . "python")
                                          (gfm-view-mode . "markdown")
                                          (rust-mode . "rust")
                                          (erlang-mode . "erlang")
                                          (css-mode . "css")
                                          (xml-mode . "xml")
                                          (c-mode . "c")
                                          (c++-mode . "cpp")
                                          (web-mode . "html")
                                          (html-mode . "html")
                                          (sgml-mode . "html")
                                          (mhtml-mode . "html")
                                          (go-mode . "go")
                                          (haskell-mode . "haskell")
                                          (json-mode . "json")
                                          (js2-mode . "javascript")
                                          (typescript-mode . "typescript")))
  #+END_SRC

** Done
  #+BEGIN_SRC emacs-lisp
  (run-with-idle-timer 4 nil
                     (lambda ()
                         "Clean up gc."
                         (setq gc-cons-threshold  67108864) ; 64M
                         (setq gc-cons-percentage 0.1) ; original value
                         (garbage-collect)))
    (provide 'init)
  #+END_SRC
